<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Categories - Two Cycles</title>
  <link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
  <header>
    <a href="index.html" style="color:#fff;text-decoration:none;">‚Üê Back</a>
    <h1>Categories</h1>
  </header>

  <div class="card">
    <h2>Add Category</h2>
    <label for="catName">Name</label>
    <input type="text" id="catName" placeholder="e.g. Groceries"/><br><br>

    <label for="catC1">Cycle 1 Budget ($)</label>
    <input type="number" step="0.01" id="catC1" placeholder="e.g. 200"/><br><br>

    <label for="catC2">Cycle 2 Budget ($)</label>
    <input type="number" step="0.01" id="catC2" placeholder="e.g. 300"/><br><br>

    <button id="addCatBtn" class="btn">Add Category</button>
  </div>

  <div class="card">
    <h2>Existing Categories</h2>
    <ul id="catList"></ul>
  </div>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection, addDoc, getDocs, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const addCatBtn = document.getElementById("addCatBtn");
    const catName   = document.getElementById("catName");
    const catC1     = document.getElementById("catC1");
    const catC2     = document.getElementById("catC2");
    const catList   = document.getElementById("catList");

    document.addEventListener("DOMContentLoaded", loadCategoriesUI);
    addCatBtn.addEventListener("click", createCategory);

    async function loadCategoriesUI() {
      catList.innerHTML = "";
      try {
        const snap = await getDocs(collection(db, "categories"));
        let cats = [];
        snap.forEach(docSnap => {
          cats.push({ id: docSnap.id, ...docSnap.data() });
        });

        cats.forEach(cat => {
          const li = document.createElement("li");
          const c1 = cat.cycle1 || 0;
          const c2 = cat.cycle2 || 0;
          const line = `${cat.name}: C1=$${c1} | C2=$${c2}`;
          li.textContent = line;

          // Delete button
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.style.marginLeft = "1rem";
          delBtn.onclick = async () => {
            if (confirm(`Delete category "${cat.name}"?`)) {
              await deleteDoc(doc(db, "categories", cat.id));
              loadCategoriesUI();
            }
          };

          // Edit button
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.style.marginLeft = "1rem";
          editBtn.onclick = async () => {
            editCategory(cat);
          };

          li.appendChild(delBtn);
          li.appendChild(editBtn);
          catList.appendChild(li);
        });
      } catch(err) {
        alert("Error loading categories: " + err.message);
      }
    }

    async function createCategory() {
      const nameVal = catName.value.trim();
      if (!nameVal) {
        alert("Please enter a category name.");
        return;
      }
      const c1Val = parseFloat(catC1.value) || 0;
      const c2Val = parseFloat(catC2.value) || 0;

      try {
        await addDoc(collection(db, "categories"), {
          name: nameVal,
          cycle1: c1Val,
          cycle2: c2Val,
          spentReset1: 0,
          spentReset2: 0
        });
        catName.value = "";
        catC1.value   = "";
        catC2.value   = "";
        loadCategoriesUI();
      } catch(err) {
        alert("Error creating category: " + err.message);
      }
    }

    async function editCategory(catObj) {
      // Prompt user for new cycle1/cycle2 budgets
      const newC1 = prompt(
        `Enter new Cycle 1 budget for "${catObj.name}":`,
        (catObj.cycle1 || 0).toString()
      );
      if (newC1 === null) return; // user cancelled
      const newC1Val = parseFloat(newC1) || 0;

      const newC2 = prompt(
        `Enter new Cycle 2 budget for "${catObj.name}":`,
        (catObj.cycle2 || 0).toString()
      );
      if (newC2 === null) return; // user cancelled
      const newC2Val = parseFloat(newC2) || 0;

      try {
        await updateDoc(doc(db, "categories", catObj.id), {
          cycle1: newC1Val,
          cycle2: newC2Val
        });
        loadCategoriesUI();
      } catch(err) {
        alert("Error editing category: " + err.message);
      }
    }
  </script>
</body>
</html>