<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Budget Status</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <style>
    .progress-container {
      background-color: #e9ecef;
      border-radius: 0.25rem;
      height: 20px;
      width: 100%;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    .progress-bar {
      background-color: #28a745;
      height: 100%;
      transition: width 0.4s ease;
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" style="color:#fff;text-decoration:none;">‚Üê Back</a>
    <h1>Budget Status</h1>
  </header>

  <div class="card">
    <h2>Available Cash</h2>
    <p id="availableCash">$0.00</p>
    <button class="btn" onclick="loadBudget()">Refresh</button>
  </div>

  <div class="card" id="budgetCard"></div>

  <script>
    const API_BASE = "https://6a9f-70-175-49-108.ngrok-free.app";

    document.addEventListener("DOMContentLoaded", loadBudget);

    async function loadBudget() {
      try {
        const res = await fetch(`${API_BASE}/budget/`);  // trailing slash
        if (!res.ok) throw new Error("Failed to fetch budget");
        const data = await res.json();

        if (data.message) {
          document.getElementById("availableCash").textContent = data.message;
          return;
        }
        document.getElementById("availableCash").textContent = `$${data.available_cash}`;

        const container = document.getElementById("budgetCard");
        container.innerHTML = `<h2>Categories</h2>`;
        let html = "<ul>";

        data.categories.forEach(cat => {
          let maxBudget = cat.is_rent ? parseFloat(cat.monthly_budget) : parseFloat(cat.biweekly_budget);
          if (maxBudget <= 0) maxBudget = 1;
          const current = parseFloat(cat.current_envelope);
          const rawPct = (current / maxBudget) * 100;
          const pct = Math.max(0, Math.min(100, rawPct));

          const leftoverStr = current.toFixed(2);
          const maxStr = maxBudget.toFixed(2);
          let line = `<strong>${cat.name}</strong>: $${leftoverStr} left of $${maxStr} `;
          let percentLine = `(${rawPct.toFixed(1)}%)`;

          let barHTML = `
            <div class="progress-container">
              <div class="progress-bar" style="width:${pct}%;"></div>
            </div>
          `;
          html += `
            <li style="margin-bottom:1rem;">
              ${line} ${percentLine}
              ${barHTML}
            </li>
          `;
        });
        html += "</ul>";
        container.innerHTML += html;
      } catch(err) {
        console.error(err);
        alert("Error loading budget: " + err.message);
      }
    }
  </script>
</body>
</html>
