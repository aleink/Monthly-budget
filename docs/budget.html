<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Budget Status (Toggle H1/H2)</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <style>
    .progress-container {
      background-color: #e9ecef;
      border-radius: 0.25rem;
      height: 20px;
      width: 100%;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    .progress-bar {
      background-color: #28a745;
      height: 100%;
      transition: width 0.4s ease;
    }
    .card ul { list-style: none; padding-left: 0; }
    .card li { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <header>
    <a href="index.html" style="color:#fff;text-decoration:none;">‚Üê Back</a>
    <h1>Budget Status</h1>
  </header>

  <div class="card">
  <h2>View Mode</h2>
  <div class="viewModeControls">
    <label><input type="radio" name="halfToggle" value="H1" checked> First Half</label>
    <label><input type="radio" name="halfToggle" value="H2"> Second Half</label>
    <button id="toggleReloadBtn" class="btn">Reload</button>
  </div>
</div>

<style>
  .viewModeControls {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .viewModeControls label {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
</style>


  <div class="card">
    <h2>Cashflow</h2>
    <div id="cashflow"></div>
  </div>

  <div class="card">
    <h2>Per-Category Leftover</h2>
    <ul id="catBudgetList"></ul>
  </div>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection, getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    let currentHalf = "H1";  // default to H1

    document.addEventListener("DOMContentLoaded", () => {
      // read radio
      const radios = document.getElementsByName("halfToggle");
      radios.forEach(r => {
        r.addEventListener("change", () => {
          currentHalf = r.value;
        });
      });
      document.getElementById("toggleReloadBtn").addEventListener("click", loadBudget);

      loadBudget();
    });

    async function loadBudget() {
      // read the current radio state
      const radios = document.getElementsByName("halfToggle");
      for (let r of radios) {
        if (r.checked) {
          currentHalf = r.value;
          break;
        }
      }

      const cashflowEl = document.getElementById("cashflow");
      const catBudgetList = document.getElementById("catBudgetList");

      try {
        // 1) sum all deposits
        const depColl = collection(db, "deposits");
        const depSnap = await getDocs(depColl);
        let depositsArr = [];
        depSnap.forEach(doc => depositsArr.push({ id: doc.id, ...doc.data() }));
        let totalDeposits = depositsArr.reduce((sum, d) => sum + (d.amount || 0), 0);

        // 2) fetch all expenses
        const txnColl = collection(db, "transactions");
        const txnSnap = await getDocs(txnColl);
        let txnsArr = [];
        txnSnap.forEach(docSnap => {
          txnsArr.push({ id: docSnap.id, ...docSnap.data() });
        });
        // filter to expense/rent_expense
        const expenseArr = txnsArr.filter(t => t.type==="expense" || t.type==="rent_expense");
        let totalExpenses = expenseArr.reduce((sum,e)=> sum+(e.amount||0),0);

        let overallCashflow = totalDeposits - totalExpenses;

        // 3) categories
        const catColl = collection(db,"categories");
        const catSnap = await getDocs(catColl);
        let categories = [];
        catSnap.forEach(docSnap => {
          categories.push({ id: docSnap.id, ...docSnap.data() });
        });

        // sum up total monthly & total bw
        let totalMO = 0;
        let totalBW = 0;
        categories.forEach(cat => {
          totalMO += (cat.monthly || 0);
          totalBW += (cat.biweekly || 0);
        });
        let secondCycle = totalMO - totalBW;
        if (secondCycle < 0) secondCycle=0;

        // Display top-level in cashflowEl
        cashflowEl.innerHTML = `
          <p>Total Deposits = $${totalDeposits.toFixed(2)}</p>
          <p>Total Expenses = $${totalExpenses.toFixed(2)}</p>
          <strong style="font-size:1.1em;">
            Available Cash = $${overallCashflow.toFixed(2)}
          </strong>
          <br><br>
          <p>
            <strong>Total MO Budget = $${totalMO.toFixed(2)}</strong><br>
            <strong>1st Cycle = $${totalBW.toFixed(2)}</strong><br>
            <strong>2nd Cycle = $${secondCycle.toFixed(2)}</strong>
          </p>
          <p>Viewing: <strong>${currentHalf==="H1"?"First Half":"Second Half"}</strong></p>
        `;

        // 4) Build spentMap for each half
        // e.g. spentH1[catId], spentH2[catId]
        let spentH1 = {};
        let spentH2 = {};

        expenseArr.forEach(txn => {
          let cId = txn.categoryId;
          let half = txn.half || "H1"; // default if missing
          if (half==="H1") {
            if (!spentH1[cId]) spentH1[cId]=0;
            spentH1[cId]+=txn.amount;
          } else {
            if (!spentH2[cId]) spentH2[cId]=0;
            spentH2[cId]+=txn.amount;
          }
        });

        // 5) Show leftover for each category
        catBudgetList.innerHTML = "";

        categories.forEach(cat => {
          // if cat.isRent => monthly, else biweekly
          // for leftover calc, we do different logic for H1 vs H2
          let monthlyVal = cat.monthly || 0;
          let bwVal = cat.biweekly || 0;
          let spentReset = cat.spentReset || 0;

          let spent1 = spentH1[cat.id] || 0;
          let spent2 = spentH2[cat.id] || 0;

          let leftover = 0;
          let line = "";

          if (currentHalf === "H1") {
            // leftover = bwVal - (spent1 - spentReset)
            // if cat.isRent => still use monthly? or do you want rent to be splitted? 
            // We'll assume we STILL use "bwVal" if !isRent. if isRent => monthly? 
            // But user wants "BW counts only for first half." Even if it's rent or not?
            // We'll do your existing logic: isRent => monthly => first half
            let budgetVal = cat.isRent ? monthlyVal : bwVal;

            leftover = budgetVal - (spent1 - spentReset);
            if (leftover<0) leftover=0;

            let pct=0;
            if (budgetVal>0) pct=(leftover/budgetVal)*100;

            line = `${cat.name} (H1): $${leftover.toFixed(2)} left of $${budgetVal.toFixed(2)} (${pct.toFixed(1)}%)`;

          } else {
            // second half
            // leftoverH1 = bwVal - (spent1 - spentReset)
            let leftoverH1 = bwVal - (spent1 - spentReset);
            if (leftoverH1<0) leftoverH1=0;

            // second half portion = monthlyVal - bwVal
            let half2portion = monthlyVal - bwVal;
            if (half2portion<0) half2portion=0;

            // leftover = leftoverH1 + half2portion - spent2
            leftover = leftoverH1 + half2portion - spent2;
            if (leftover<0) leftover=0;

            // percentage based on the entire monthlyVal
            // or you can base it on just half2portion + leftoverH1? 
            // We'll do entire monthly, to see how close to mo
            let pct=0;
            if (monthlyVal>0) {
              pct = (leftover / monthlyVal)*100;
            }

            line = `${cat.name} (H2): $${leftover.toFixed(2)} left of $${monthlyVal.toFixed(2)} (${pct.toFixed(1)}%)`;
          }

          // Build DOM
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${line}</strong>
            <div class="progress-container">
              <div class="progress-bar" style="width:0%;"></div>
            </div>
          `;
          // set bar width
          let bar = li.querySelector(".progress-bar");
          // parse out the leftover vs budget?
          // we already have leftover & a budgetVal, let's do the same calc
          // but let's do budgetVal for the relevant portion
          // or if H2, we used monthly for the percentage above
          let barPct = 0;
          if (currentHalf==="H1") {
            let budgetVal = cat.isRent ? monthlyVal : bwVal;
            if (budgetVal>0) barPct=(leftover / budgetVal)*100;
          } else {
            // second half, we decided to do leftover / monthlyVal for display
            if (monthlyVal>0) barPct=(leftover / monthlyVal)*100;
          }
          bar.style.width=`${barPct}%`;

          // add reset button
          const resetBtn = document.createElement("button");
          resetBtn.textContent="Reset Budget";
          resetBtn.style.marginLeft="1rem";
          resetBtn.onclick=async()=>{
            if (confirm(`Reset '${cat.name}' budget for the entire month?`)) {
              // We'll set spentReset to the total spent in H1+H2 => leftover => monthlyVal
              let totalSpent = spent1+spent2;
              await updateDoc(doc(db,"categories", cat.id), {
                spentReset: totalSpent
              });
              loadBudget();
            }
          };
          li.appendChild(resetBtn);

          catBudgetList.appendChild(li);
        });
      } catch(err) {
        catBudgetList.innerHTML=`<li>Error: ${err.message}</li>`;
      }
    }
  </script>
</body>
</html>
