<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Budget Status - With Reset + Totals</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <style>
    .progress-container {
      background-color: #e9ecef;
      border-radius: 0.25rem;
      height: 20px;
      width: 100%;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    .progress-bar {
      background-color: #28a745;
      height: 100%;
      transition: width 0.4s ease;
    }
    .card ul { list-style: none; padding-left: 0; }
    .card li { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <header>
    <a href="index.html" style="color:#fff;text-decoration:none;">← Back</a>
    <h1>Budget Status</h1>
  </header>

  <div class="card">
    <h2>Cashflow</h2>
    <div id="cashflow"></div>
  </div>

  <div class="card">
    <h2>Per-Category Budgets</h2>
    <ul id="catBudgetList"></ul>
  </div>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection, getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    document.addEventListener("DOMContentLoaded", loadBudget);

    async function loadBudget() {
      const cashflowEl = document.getElementById("cashflow");
      const catBudgetList = document.getElementById("catBudgetList");

      try {
        // 1) Sum of all deposits
        const depColl = collection(db, "deposits");
        const depSnap = await getDocs(depColl);
        let depositsArr = [];
        depSnap.forEach(doc => depositsArr.push({ id: doc.id, ...doc.data() }));
        let totalDeposits = depositsArr.reduce((sum, d) => sum + (d.amount || 0), 0);

        // 2) Sum of all expenses
        const txnColl = collection(db, "transactions");
        const txnSnap = await getDocs(txnColl);
        let txnsArr = [];
        txnSnap.forEach(doc => txnsArr.push({ id: doc.id, ...doc.data() }));
        const expenseArr = txnsArr.filter(t => t.type === "expense" || t.type === "rent_expense");
        let totalExpenses = expenseArr.reduce((sum, e) => sum + (e.amount || 0), 0);

        let overallCashflow = totalDeposits - totalExpenses;

        // 3) Fetch all categories
        const catColl = collection(db, "categories");
        const catSnap = await getDocs(catColl);
        let categories = [];
        catSnap.forEach(c => {
          categories.push({ id: c.id, ...c.data() });
        });

        // 4) Calculate "Total MO Budget" & "Total BW Budget"
        let totalMO = 0;
        let totalBW = 0;
        categories.forEach(cat => {
          totalMO += (cat.monthly || 0);
          totalBW += (cat.biweekly || 0);
        });

        // 5) Display top-level stats in cashflowEl
        cashflowEl.innerHTML = `
          <p>Total Deposits = $${totalDeposits.toFixed(2)}</p>
          <p>Total Expenses = $${totalExpenses.toFixed(2)}</p>
          <strong style="font-size:1.1em;">
            Available Cash = $${overallCashflow.toFixed(2)}
          </strong>
          <br><br>
          <p>
            <strong>Total MO Budget = $${totalMO.toFixed(2)}</strong><br>
            <strong>Total BW Budget = $${totalBW.toFixed(2)}</strong>
          </p>
        `;

        // 6) Build a spentMap => categoryId => totalSpent
        let spentMap = {};
        expenseArr.forEach(txn => {
          let cId = txn.categoryId;
          if (!spentMap[cId]) spentMap[cId] = 0;
          spentMap[cId] += txn.amount;
        });

        // 7) Show each category’s leftover & a Reset button
        catBudgetList.innerHTML = "";

        categories.forEach(cat => {
          // half logic => leftover = budgetVal - (spentVal - spentReset)
          // cat.isRent => use cat.monthly, otherwise cat.biweekly
          let budgetVal = cat.isRent ? (cat.monthly || 0) : (cat.biweekly || 0);
          let spentVal = spentMap[cat.id] || 0;
          let spentReset = cat.spentReset || 0;  // default 0 if missing

          let leftover = budgetVal - (spentVal - spentReset);
          if (leftover < 0) leftover = 0;

          let pct = 0;
          if (budgetVal > 0) {
            pct = (leftover / budgetVal) * 100;
          }

          let line = `${cat.name}: $${leftover.toFixed(2)} left of $${budgetVal.toFixed(2)} (${pct.toFixed(1)}%)`;

          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${line}</strong>
            <div class="progress-container">
              <div class="progress-bar" style="width:${pct}%;"></div>
            </div>
          `;

          // RESET button
          const resetBtn = document.createElement("button");
          resetBtn.textContent = "Reset Budget";
          resetBtn.style.marginLeft = "1rem";
          resetBtn.onclick = async () => {
            if (confirm(`Reset '${cat.name}' budget to full? This won't delete old transactions.`)) {
              // set cat.spentReset to spentVal
              // leftover => budgetVal
              await updateDoc(doc(db, "categories", cat.id), {
                spentReset: spentVal
              });
              loadBudget(); // refresh
            }
          };

          li.appendChild(resetBtn);
          catBudgetList.appendChild(li);
        });

      } catch(err) {
        catBudgetList.innerHTML = `<li>Error: ${err.message}</li>`;
      }
    }
  </script>
</body>
</html>
