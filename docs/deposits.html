<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Budget Bot - Deposits</title>
  <link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
  <header>
    <div class="header-branding">
      <h1>Budget Bot</h1>
      <button id="theme-toggle" aria-label="Toggle theme">Toggle Theme</button>
    </div>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="categories.html">Categories</a></li>
            <li><a href="deposits.html" class="active">Deposits</a></li>
            <li><a href="transactions.html">Expenses</a></li>
            <li><a href="budget.html">Budget</a></li>
        </ul>
    </nav>
  </header>
  <main>
    <div class="card text-center"> 
      <h2>Available Cash</h2>
      <p id="available-cash-amount" class="text-large">Calculating...</p>
      <p class="text-muted mt-1">This is your total deposits minus total expenses.</p>
    </div>

    <div class="card">
      <h2>Record New Deposit</h2>
      <div class="form-group">
        <label for="depType">Deposit Type</label>
        <select id="depType">
          <option value="paycheck">Paycheck</option>
          <option value="atm">ATM Deposit</option>
          <option value="bonus">Bonus</option>
          <option value="other">Other Income</option>
        </select>
      </div>
      <div class="form-group">
        <label for="depAmount">Amount ($)</label>
        <input type="number" step="0.01" id="depAmount" placeholder="e.g., 500.00"/>
      </div>
      <div class="form-group">
        <label for="depDate">Date of Deposit</label>
        <input type="date" id="depDate"/>
      </div>
      <button id="addDepBtn" class="btn">Add Deposit</button>
    </div>

    <div class="card">
      <h2>Recent Deposits</h2>
      <p class="text-muted">View or delete your recent deposits below.</p>
      <ul id="depList" class="styled-list">
        <!-- 
          Example LI structure for JS to build:
          <li>
            <div class="list-item-info">
              <span class="item-name">Paycheck</span>
              <span class="item-detail">Amount: $500.00</span>
              <span class="item-detail">Date: 2023-10-26</span>
            </div>
            <div class="list-item-actions">
              <button class="btn btn-sm btn-delete">Delete</button>
            </div>
          </li> 
        -->
      </ul>
    </div>
  </main>
  <script src="assets/theme.js"></script>
  <script type="module">
    // Corrected path for firebase.js (assuming it's in parent directory of 'docs')
    import { db } from "../firebase.js"; 
    import {
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      doc
    // Corrected path for Firestore SDK functions (assuming local ES module)
    } from "../../firebase/firebase-firestore.js"; 

    const depAmtEl = document.getElementById("depAmount");
    const depDateEl = document.getElementById("depDate"); 
    const addDepBtn = document.getElementById("addDepBtn");
    const depListEl = document.getElementById("depList");
    const availableCashAmountEl = document.getElementById("available-cash-amount"); // Updated ID

    document.addEventListener("DOMContentLoaded", () => { 
      if (depDateEl) {
        depDateEl.valueAsDate = new Date();
      }
      updateFinancialOverview(); // Renamed function call
    });
    addDepBtn.addEventListener("click", onAddDeposit);

    async function updateFinancialOverview() { 
      depListEl.innerHTML = ""; 
      if (availableCashAmountEl) availableCashAmountEl.textContent = "Calculating...";
      
      let totalDeposits = 0;
      let totalExpenses = 0;
      let deposits = [];
      let errorOccurred = false;

      // Step 1: Fetch and process deposits
      try {
        const depositsCollRef = collection(db, "deposits");
        const depositsSnap = await getDocs(depositsCollRef);
        depositsSnap.forEach(docSnap => {
          const depositData = docSnap.data();
          deposits.push({ id: docSnap.id, ...depositData });
          if (typeof depositData.amount === 'number') {
            totalDeposits += depositData.amount;
          }
        });
      } catch (err) {
        console.error("Error loading deposits: ", err);
        depListEl.innerHTML = "<li class='text-danger'>Could not load deposit list.</li>";
        errorOccurred = true;
        // Potentially alert for deposits specific error: alert("Error loading deposit data: " + err.message);
      }

      // Step 2: Fetch and process transactions (expenses)
      try {
        const expensesCollRef = collection(db, "transactions");
        const expensesSnap = await getDocs(expensesCollRef);
        expensesSnap.forEach(docSnap => {
          const expenseData = docSnap.data();
          if (typeof expenseData.amount === 'number') {
            totalExpenses += expenseData.amount;
          }
        });
      } catch (err) {
        console.error("Error loading transactions for available cash calculation: ", err);
        // Don't set errorOccurred to true here if deposits loaded,
        // as we might still want to display available cash based on deposits alone
        // or indicate that expenses couldn't be factored in.
        if (availableCashAmountEl) availableCashAmountEl.textContent = "Error (Expenses)";
        // Potentially alert for transaction specific error: alert("Error loading expense data: " + err.message);
      }

      // Step 3: Calculate and display available cash
      if (availableCashAmountEl && !availableCashAmountEl.textContent.includes("Error")) { // Check if error already set by expenses
        const availableCash = totalDeposits - totalExpenses;
        availableCashAmountEl.textContent = `$${availableCash.toFixed(2)}`;
      } else if (errorOccurred && availableCashAmountEl) { // If deposits failed
         availableCashAmountEl.textContent = "Error";
      }


      // Step 4: Sort and display deposits (only if successfully fetched)
      if (deposits.length > 0 || !errorOccurred) { // Display even if empty, unless initial deposit load failed
        deposits.sort((a, b) => {
          const dateA = a.timestamp ? new Date(a.timestamp) : 0;
          const dateB = b.timestamp ? new Date(b.timestamp) : 0;
          return dateB - dateA; // Sort descending
        });

        deposits.forEach(dep => {
          const li = document.createElement("li");

          const infoDiv = document.createElement("div");
          infoDiv.className = "list-item-info";

          const typeSpan = document.createElement("span");
          typeSpan.className = "item-name"; 
          typeSpan.textContent = dep.type.charAt(0).toUpperCase() + dep.type.slice(1); 
          infoDiv.appendChild(typeSpan);

          const amountSpan = document.createElement("span");
          amountSpan.className = "item-detail"; 
          amountSpan.textContent = `Amount: $${(dep.amount || 0).toFixed(2)}`;
          infoDiv.appendChild(amountSpan);
          
          const dateStr = dep.timestamp ? new Date(dep.timestamp).toLocaleDateString() : "Unknown Date";
          const dateSpan = document.createElement("span");
          dateSpan.className = "item-detail";
          dateSpan.textContent = `Date: ${dateStr}`;
          infoDiv.appendChild(dateSpan);

          li.appendChild(infoDiv);

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "list-item-actions";

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "btn btn-sm btn-delete"; 
          delBtn.onclick = async () => {
            if (confirm(`Delete deposit of $${(dep.amount || 0).toFixed(2)}? This action cannot be undone.`)) {
              await deleteDoc(doc(db, "deposits", dep.id));
              updateFinancialOverview(); 
            }
          };
          actionsDiv.appendChild(delBtn);

          li.appendChild(actionsDiv);
          depListEl.appendChild(li);
        });
      }
      // Removed the broad catch here to allow separate error handling for deposits and transactions
      // If a global error needs to be caught (e.g., for UI updates common to both), it can be wrapped higher up.
    }

    async function onAddDeposit() {
      const typeVal = depTypeEl.value;
      const amtVal = parseFloat(depAmtEl.value.trim());
      const dateVal = depDateEl.value; // Get date value

      if (isNaN(amtVal) || amtVal <= 0) {
        alert("Please enter a valid positive amount for the deposit.");
        return;
      }
      if (!dateVal) {
        alert("Please select a date for the deposit.");
        return;
      }
      // Convert selected date to ISO string at the beginning of the day in local timezone
      const selectedDate = new Date(dateVal);
      selectedDate.setHours(0, 0, 0, 0); // Set to start of day
      const timestamp = selectedDate.toISOString();

      try {
        const collRef = collection(db, "deposits");
        await addDoc(collRef, {
          type: typeVal,
          amount: amtVal,
          timestamp: timestamp // Use the selected date
        });
        depAmtEl.value = ""; // Clear amount
        // depDateEl.valueAsDate = new Date(); 
        updateFinancialOverview(); // Renamed function call
      } catch(err) {
        alert("Error creating deposit: " + err.message);
      }
    }
  </script>
</body>
</html>
