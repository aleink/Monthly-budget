<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Expenses - Budget Bot</title>
  <link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
  <header>
    <a href="index.html" style="color:#fff;text-decoration:none;">‚Üê Back</a>
    <h1>Expenses</h1>
  </header>

  <div class="card">
    <h2>Create Expense</h2>
    <label>Type:
      <select id="txnType">
        <option value="expense">Expense</option>
        <option value="rent_expense">Rent Expense</option>
      </select>
    </label>
    <br><br>
    <label>Category:
      <select id="txnCat"></select>
    </label>
    <br><br>
    <label>Amount ($)
      <input type="number" step="0.01" id="txnAmt" placeholder="e.g. 50.00"/>
    </label>
    <br><br>
    <button id="txnAddBtn" class="btn">Add Expense</button>
  </div>

  <div class="card">
    <h2>Existing Expenses</h2>
    <ul id="txnList"></ul>
  </div>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const txnTypeEl = document.getElementById("txnType");
    const txnCatEl = document.getElementById("txnCat");
    const txnAmtEl = document.getElementById("txnAmt");
    const txnAddBtn = document.getElementById("txnAddBtn");
    const txnListEl = document.getElementById("txnList");

    // On load, we want to load categories for the dropdown, and load existing expenses
    document.addEventListener("DOMContentLoaded", async () => {
      await loadCategoriesForDropdown();
      await loadExpensesUI();
    });

    txnAddBtn.addEventListener("click", onAddTxn);

    async function loadCategoriesForDropdown() {
      txnCatEl.innerHTML = "";
      try {
        // fetch categories from Firestore
        const catCollRef = collection(db, "categories");
        const snap = await getDocs(catCollRef);
        let cats = [];
        snap.forEach(docSnap => {
          cats.push({ id: docSnap.id, ...docSnap.data() });
        });
        // populate dropdown
        cats.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat.id;
          opt.textContent = `${cat.name}`;
          txnCatEl.appendChild(opt);
        });
      } catch(err) {
        alert("Error loading categories: " + err.message);
      }
    }

    async function loadExpensesUI() {
      txnListEl.innerHTML = "";
      try {
        const txnCollRef = collection(db, "transactions");
        const snap = await getDocs(txnCollRef);
        let txns = [];
        snap.forEach(docSnap => {
          txns.push({ id: docSnap.id, ...docSnap.data() });
        });
        // filter to expense/rent_expense only
        txns = txns.filter(t => t.type === "expense" || t.type === "rent_expense");

        // For display, we might want category name. So let's also fetch categories quickly
        const catCollRef = collection(db, "categories");
        const catSnap = await getDocs(catCollRef);
        let catMap = {};
        catSnap.forEach(docSnap => {
          catMap[docSnap.id] = docSnap.data().name;
        });

        txns.forEach(txn => {
          const li = document.createElement("li");
          const catName = catMap[txn.categoryId] || "UnknownCat";
          const dateStr = txn.timestamp ? txn.timestamp.split("T")[0] : "";
          li.textContent = `${txn.type} - $${txn.amount} on ${dateStr}, cat=${catName}`;

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.style.marginLeft = "1rem";
          delBtn.onclick = async () => {
            if (confirm(`Delete this expense of $${txn.amount}?`)) {
              await deleteDoc(doc(db, "transactions", txn.id));
              loadExpensesUI();
            }
          };

          li.appendChild(delBtn);
          txnListEl.appendChild(li);
        });
      } catch(err) {
        alert("Error loading expenses: " + err.message);
      }
    }

    async function onAddTxn() {
      const typeVal = txnTypeEl.value;
      const catIdVal = txnCatEl.value;  // doc ID from categories
      const amtVal = parseFloat(txnAmtEl.value.trim()) || 0;
      if (!catIdVal) {
        alert("Select a category!");
        return;
      }
      if (amtVal <= 0) {
        alert("Enter a positive amount!");
        return;
      }
      try {
        const txnCollRef = collection(db, "transactions");
        await addDoc(txnCollRef, {
          type: typeVal,
          categoryId: catIdVal,
          amount: amtVal,
          timestamp: new Date().toISOString()
        });
        txnAmtEl.value = "";
        await loadExpensesUI();
      } catch(err) {
        alert("Error creating expense: " + err.message);
      }
    }
  </script>
</body>
</html>
